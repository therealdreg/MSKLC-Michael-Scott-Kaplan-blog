<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/25/5686727.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Not all in sync quite yet (aka SQL and the CLR and Windows and .NET)</title></head><body>
<h1>Not all in sync quite yet (aka SQL and the CLR and Windows and .NET)</h1>
<p><em>by Michael S. Kaplan, published on 2007/10/25 15:31 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/10/25/5686727.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Regular reader Jan Kučera asks over in the Suggestion Box:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>Hello,<BR><BR>Yet another possible suggestion from my thoughts... If one has (yes, I am the one :)) a central database for multi-cultural data (that means, in one column the entries could be in English, Hebrew, Chinese and so on) and expects it to be quered from multiple cultures, what collation should one choose for the database?<BR><BR>I guess that - to honor the "sort in locale, which user expects - the user's locale" rule - on should use COLLATE in the SELECT statement. But how do I get the SQL value for COLLATE from CultureInfo instance?<BR><BR>And last one, how about specifying the collation in LINQ to SQL? I haven't seen any LINQ example using collate keyword so I'm getting afraid this was quite forgotten in LINQ, wasn't it?<BR><BR>Thank you for sharing any of your thoughts,<BR><BR>&nbsp;&nbsp;&nbsp; Jan</EM></FONT></P></BLOCKQUOTE>
<P>Jan's guess is correct, though I must admit that he is also correct that SQL Server is not going out of its way to make&nbsp;the mapping&nbsp;easy!</P>
<P>But I'll try to help out here a bit if I can, as it ends up being easier than it looks....</P>
<P>We'll start with a SQL query, the one from my old post <A class="" href="http://archives.miloush.net/michkap/archive/2005/06/09/427293.html" mce_href="http://archives.miloush.net/michkap/archive/2005/06/09/427293.html"><STRONG>String.Compare is for sissies (not for people who want SQLCLR consistency)</STRONG></A>, which by the way when I was looking at stats the other day is inexplicably one of my often-read posts! :-)</P>
<P>The query:</P>
<BLOCKQUOTE>
<P><FONT face="Consolas,Lucida Console,Courier New,Courier,Fixed" size=2><STRONG>SELECT <BR>&nbsp;&nbsp;&nbsp; name, <BR>&nbsp;&nbsp;&nbsp; COLLATIONPROPERTY(name, 'CodePage') as CodePage, <BR>&nbsp;&nbsp;&nbsp; CONVERT(binary(4), COLLATIONPROPERTY(name, 'LCID')) as LCID, <BR>&nbsp;&nbsp;&nbsp; CONVERT(binary(4), COLLATIONPROPERTY(name, 'ComparisonStyle')) as ComparisonStyle, <BR>&nbsp;&nbsp;&nbsp; description <BR>FROM ::fn_helpcollations()</STRONG> </FONT></P></BLOCKQUOTE>
<P mce_keep="true">Now this will give you the huge master list of all the collations, expanded for the various styles but contracted to make sure identical sorts with identical code pages have only a single collation to represent them.</P>
<P mce_keep="true">Obviously one could add a WHERE clause to translate CultureInfo.CompareInfo.LCID to a SQL collation:</P>
<BLOCKQUOTE>
<P mce_keep="true"><STRONG><FONT face=Consolas>WHERE COLLATIONPROPERTY(name, 'LCID') = 1036</FONT></STRONG></P></BLOCKQUOTE>
<P mce_keep="true">and then you will get all of the French collations, for example.</P>
<P mce_keep="true">Now at this point the collations that have&nbsp;been folded together intrude.</P>
<P mce_keep="true">Let's tale the following three LCIDs (which use the same sort in SQL Server 2005 and earlier though not in Vista as I discuss in <A class="" href="http://archives.miloush.net/michkap/archive/2006/04/27/584439.html" mce_href="http://archives.miloush.net/michkap/archive/2006/04/27/584439.html"><STRONG>The disunification of Norwegian and Danish sorting</STRONG></A>):</P>
<UL>
<LI>
<DIV mce_keep="true">0x00000406&nbsp;&nbsp;&nbsp; Danish</DIV></LI>
<LI>
<DIV mce_keep="true">0x00000414&nbsp;&nbsp;&nbsp; Norwegian (Bokmal)</DIV></LI>
<LI>
<DIV mce_keep="true">0x00000814&nbsp;&nbsp;&nbsp; Norwegian (Nynorsk)</DIV></LI></UL>
<P mce_keep="true">If we run a query looking for any of them:</P>
<BLOCKQUOTE>
<P><FONT face="Consolas,Lucida Console,Courier New,Courier,Fixed" size=2><STRONG>SELECT <BR>&nbsp;&nbsp;&nbsp; name, <BR>&nbsp;&nbsp;&nbsp; COLLATIONPROPERTY(name, 'CodePage') as CodePage, <BR>&nbsp;&nbsp;&nbsp; CONVERT(binary(4), COLLATIONPROPERTY(name, 'LCID')) as LCID, <BR>&nbsp;&nbsp;&nbsp; CONVERT(binary(4), COLLATIONPROPERTY(name, 'ComparisonStyle')) as ComparisonStyle, <BR>&nbsp;&nbsp;&nbsp; description <BR>FROM ::fn_helpcollations() <BR>WHERE <BR>&nbsp;&nbsp;&nbsp; COLLATIONPROPERTY(name, 'LCID') = 1030 OR<BR>&nbsp;&nbsp;&nbsp; COLLATIONPROPERTY(name, 'LCID') = 1044 OR<BR>&nbsp;&nbsp;&nbsp; COLLATIONPROPERTY(name, 'LCID') = 2068</STRONG></FONT></P></BLOCKQUOTE>
<P mce_keep="true">Then in SQL Server 2005 it will return 20 rows:</P>
<BLOCKQUOTE>
<P mce_keep="true"><FONT face="Consolas,Lucida Console,Courier New,Courier,Fixed" size=1>Danish_Norwegian_BIN&nbsp;1252&nbsp;0x00000406&nbsp;0x00000000&nbsp;Danish-Norwegian, binary sort<BR>Danish_Norwegian_BIN2&nbsp;1252&nbsp;0x00000406&nbsp;0x00000000&nbsp;Danish-Norwegian, binary code point comparison sort<BR>Danish_Norwegian_CI_AI&nbsp;1252&nbsp;0x00000406&nbsp;0x00030003&nbsp;Danish-Norwegian, case-insensitive, accent-insensitive, kanatype-insensitive, width-insensitive<BR>Danish_Norwegian_CI_AI_WS&nbsp;1252&nbsp;0x00000406&nbsp;0x00010003&nbsp;Danish-Norwegian, case-insensitive, accent-insensitive, kanatype-insensitive, width-sensitive<BR>Danish_Norwegian_CI_AI_KS&nbsp;1252&nbsp;0x00000406&nbsp;0x00020003&nbsp;Danish-Norwegian, case-insensitive, accent-insensitive, kanatype-sensitive, width-insensitive<BR>Danish_Norwegian_CI_AI_KS_WS&nbsp;1252&nbsp;0x00000406&nbsp;0x00000003&nbsp;Danish-Norwegian, case-insensitive, accent-insensitive, kanatype-sensitive, width-sensitive<BR>Danish_Norwegian_CI_AS&nbsp;1252&nbsp;0x00000406&nbsp;0x00030001&nbsp;Danish-Norwegian, case-insensitive, accent-sensitive, kanatype-insensitive, width-insensitive<BR>Danish_Norwegian_CI_AS_WS&nbsp;1252&nbsp;0x00000406&nbsp;0x00010001&nbsp;Danish-Norwegian, case-insensitive, accent-sensitive, kanatype-insensitive, width-sensitive<BR>Danish_Norwegian_CI_AS_KS&nbsp;1252&nbsp;0x00000406&nbsp;0x00020001&nbsp;Danish-Norwegian, case-insensitive, accent-sensitive, kanatype-sensitive, width-insensitive<BR>Danish_Norwegian_CI_AS_KS_WS&nbsp;1252&nbsp;0x00000406&nbsp;0x00000001&nbsp;Danish-Norwegian, case-insensitive, accent-sensitive, kanatype-sensitive, width-sensitive<BR>Danish_Norwegian_CS_AI&nbsp;1252&nbsp;0x00000406&nbsp;0x00030002&nbsp;Danish-Norwegian, case-sensitive, accent-insensitive, kanatype-insensitive, width-insensitive<BR>Danish_Norwegian_CS_AI_WS&nbsp;1252&nbsp;0x00000406&nbsp;0x00010002&nbsp;Danish-Norwegian, case-sensitive, accent-insensitive, kanatype-insensitive, width-sensitive<BR>Danish_Norwegian_CS_AI_KS&nbsp;1252&nbsp;0x00000406&nbsp;0x00020002&nbsp;Danish-Norwegian, case-sensitive, accent-insensitive, kanatype-sensitive, width-insensitive<BR>Danish_Norwegian_CS_AI_KS_WS&nbsp;1252&nbsp;0x00000406&nbsp;0x00000002&nbsp;Danish-Norwegian, case-sensitive, accent-insensitive, kanatype-sensitive, width-sensitive<BR>Danish_Norwegian_CS_AS&nbsp;1252&nbsp;0x00000406&nbsp;0x00030000&nbsp;Danish-Norwegian, case-sensitive, accent-sensitive, kanatype-insensitive, width-insensitive<BR>Danish_Norwegian_CS_AS_WS&nbsp;1252&nbsp;0x00000406&nbsp;0x00010000&nbsp;Danish-Norwegian, case-sensitive, accent-sensitive, kanatype-insensitive, width-sensitive<BR>Danish_Norwegian_CS_AS_KS&nbsp;1252&nbsp;0x00000406&nbsp;0x00020000&nbsp;Danish-Norwegian, case-sensitive, accent-sensitive, kanatype-sensitive, width-insensitive<BR>Danish_Norwegian_CS_AS_KS_WS&nbsp;1252&nbsp;0x00000406&nbsp;0x00000000&nbsp;Danish-Norwegian, case-sensitive, accent-sensitive, kanatype-sensitive, width-sensitive<BR>SQL_Danish_Pref_CP1_CI_AS&nbsp;1252&nbsp;0x00000406&nbsp;0x00030001&nbsp;Danish-Norwegian, case-insensitive, accent-sensitive, kanatype-insensitive, width-insensitive for Unicode Data, SQL Server Sort Order 183 on Code Page 1252 for non-Unicode Data<BR>SQL_EBCDIC277_CP1_CS_AS&nbsp;1252&nbsp;0x00000406&nbsp;0x00030000&nbsp;Danish-Norwegian, case-sensitive, accent-sensitive, kanatype-insensitive, width-insensitive for Unicode Data, SQL Server Sort Order 212 on Code Page 1252 for non-Unicode Data</FONT></P></BLOCKQUOTE>
<P mce_keep="true">Notice that none of them fit under anything other than 0x0406, Danish.</P>
<P mce_keep="true">So how do you get to this collation from the other two LCIDs?</P>
<P mce_keep="true">Unfortunately, there is no programmatic way out there and the only place it happens to show up in documentation is a table in the documentation topic entitled <A class="" href="http://msdn2.microsoft.com/library/ms143508.aspx" mce_href="http://msdn2.microsoft.com/library/ms143508.aspx">Collation Settings in Setup</A>, which maps locales from Windows 2000/XP/Server 2003 to the ideal collation to use in SQL Server (you can ignore the various flag settings and use the ones you prefer, with one sxception -- US English should use Latin1_General, NOT SQL_Latin1_General_CP1_CI_AS, because as I have pointed out&nbsp;<A class="" href="http://archives.miloush.net/michkap/archive/2005/11/08/490305.html" mce_href="http://archives.miloush.net/michkap/archive/2005/11/08/490305.html"><STRONG>time</STRONG></A> <A class="" href="http://archives.miloush.net/michkap/archive/2006/10/29/897317.html" mce_href="http://archives.miloush.net/michkap/archive/2006/10/29/897317.html"><STRONG>and</STRONG></A> <A class="" href="http://archives.miloush.net/michkap/archive/2006/06/06/618798.html" mce_href="http://archives.miloush.net/michkap/archive/2006/06/06/618798.html"><STRONG>time</STRONG></A> <A class="" href="http://archives.miloush.net/michkap/archive/2006/06/02/615536.html" mce_href="http://archives.miloush.net/michkap/archive/2006/06/02/615536.html"><STRONG>again</STRONG></A>, SQL comaptibility collations really suck. :-)&nbsp;</P>
<P mce_keep="true">Going the other direction is easier, since you can always create a CultureInfo or a CompareInfo using the LCID that is available to every collation.</P>
<P mce_keep="true">To answer that last question, as <A class="" href="http://msdn2.microsoft.com/library/bb425822.aspx" mce_href="http://msdn2.microsoft.com/library/bb425822.aspx">LINQ to SQL: .NET Language-Integrated Query for Relational Data</A> points out:</P>
<BLOCKQUOTE>
<P mce_keep="true"><EM>SQL uses collations to determine equality and ordering of strings. These can be specified on a SQL Server Instance, a database, a table column, or an expression.<BR><BR>The translations of the functions implemented so far do not change the collation or specify a different collation on the translated expressions. So if the default collation is case-insensitive, functions like CompareTo or IndexOf can give results that differ from what the (case sensitive) .NET functions would give.<BR><BR>The methods StartsWith(str)/EndsWith(str) assume the argument str is a constant or an expression that is evaluated on the client. That is, it is currently not possible to use a column for str.</EM></P></BLOCKQUOTE>
<P mce_keep="true">There does not appear to be any inbuilt solution in LINQ, unfortunately.</P>
<P mce_keep="true">I'll continue on with the attempting to solve the problem via description as we wait for the documenting of the workarounds...</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post was brought to you by a bunch of Unicode characters....</EM></FONT></P>
<hr/><p><a id="5688417" href="#5688417">#</a> <strong>Michael S. Kaplan</strong> on 26 Oct 2007 5:34 AM:</p><div style="margin-left: 1em"><P>Now I believe there are hooks here like GetCultureInfo(string, string)&nbsp;(<A class="" href="http://archives.miloush.net/michkap/archive/2005/10/09/478705.html"><STRONG>ref</STRONG></A>)&nbsp;and such, but I am not sure how much of that is hooked up on the SQLCLR side yet?</P></div>
<p><a id="5795407" href="#5795407">#</a> <strong>Jan Kučera</strong> on 31 Oct 2007 4:52 AM:</p><div style="margin-left: 1em"><p>Hello Michael,</p>
<p> thank you for getting to it, it explains a lot to me. Well I'm completely unfamiliar with SQLCLR so I'll have to check this technology out.</p>
<p> So, to ensure my thoughts: if there is no culture prefered over another one in queries, it completely does not matter what the server's default/database collation is set to?</p>
<p> If I use COLLATE, does the server store indices for later use? Or could I somehow specify for which cultures it should build the indices?</p>
<p> &nbsp; &nbsp; &nbsp;Thanks, Jan</p>
</div>
<p><a id="5797606" href="#5797606">#</a> <strong>Michael S. Kaplan</strong> on 31 Oct 2007 8:06 AM:</p><div style="margin-left: 1em"><P>I talk about how to index specific collations separately in <A class="" href="http://archives.miloush.net/michkap/archive/2005/05/06/415199.html"><STRONG>this</STRONG></A> post....</P></div>
<p><a id="5800040" href="#5800040">#</a> <strong>Michael S. Kaplan</strong> on 31 Oct 2007 11:39 AM:</p><div style="margin-left: 1em"><p>As for the server/db collation, there are specific benefits to choosing them carefully, but that is a much larger topic, one that goes beyond the scope of what I was covering here. Another day....</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/03/27 <a href="http://archives.miloush.net/michkap/archive/2008/03/27/8338664.html">The disunification of Norwegian and Danish sorting ( SQL Server 2008 Edition!)</a></p><p>2007/12/11 <a href="http://archives.miloush.net/michkap/archive/2007/12/11/6730684.html">In SQL Server, there is the rest of Unicode (aka the SiaO Incompleteness Theorem)</a></p><p>2007/11/26 <a href="http://archives.miloush.net/michkap/archive/2007/11/26/6527833.html">When yesterday's workaround becomes tomorrow's potential solution...</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/10/26/5677426.html" title="Superstition: Why MSLU stopped using GetFileAttributesW in its platform detection">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/10/25/5664770.html" title="Jokes that aren&#39;t really all that funny in the end (aka At least SQL Server isn&#39;t on our case)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10-25">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/25/5686727.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>