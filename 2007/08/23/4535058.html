<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/08/23/4535058.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Getting the language (and more!) of an LCID-less keyboard</title></head><body>
<h1>Getting the language (and more!) of an LCID-less keyboard</h1>
<p><em>by Michael S. Kaplan, published on 2007/08/23 22:05 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/08/23/4535058.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>So back in May when I was talking about <a href="http://archives.miloush.net/michkap/archive/2007/05/22/2800224.html"><strong>Getting the language of an LCID-less keyboard</strong></a>, I promised to do a bit more explaining about how support for custom locales was integrated into MSKLC 1.4, so that people could write code to work with specific keyboards.</p> <p>I've been busy so I did not get to it right away, but I am going to talk about it a bit more now. :-)</p> <p>It was actually way back in 2004 in <a href="http://archives.miloush.net/michkap/archive/2004/11/27/270931.html"><strong>Some Keyboarding Terms</strong></a> that the story begins; in that post I discussed the Keyboard Layout Identifier (KLID) and the fact that a KLID value with an "A" prefix meant an MSKLC-created layout. And I have talked about KLID values <a href="http://archives.miloush.net/michkap/search.aspx?q=KLID&amp;p=1"><strong>a few times</strong></a> since then, including that time in May when I talked about the custom ones.</p> <p>I don't think I have ever explained what the install package for the keyboard provided by MSKLC does, though, so I'll start there.</p> <p>Let's say we have installed that Valley Girl custom locale I asked Shawn to make for our fearless leader that I talk about in <a href="http://archives.miloush.net/michkap/archive/2006/11/09/1043843.html"><strong>You wonder if like Vista supports custom locales? Fer shur!</strong></a>. It will show&nbsp;up in the&nbsp;Vista&nbsp;and Server 2008 user interface:</p> <p><img src="http://trigeminal.fmsinc.com/images/valleygirl01.png"></p> <p>The fact that it is installed on Windows will mean that MSKLC picks it up in its own language list from Project|Properties, whether you select it as I have or not:</p> <p><img src="http://trigeminal.fmsinc.com/images/valleygirl02.png"></p> <p>When the install package is built, it will include a LANGID value in it (it will end up in the MSI Property table, in string form in the <strong>LCIDValue</strong>&nbsp;property, in&nbsp;numeric form in the <strong>ProductLanguage</strong> property. For custom locales, the values of&nbsp;0c00&nbsp;and 3072&nbsp;are used.</p> <p>At install time of that package, a small process occurs:</p> <ol> <li>That LANGID is used as the LOWORD of the KLID of the keyboard -- thus for our custom locale we have 0x00000c00;  <li>An "A" prefix is put in the front, to signify an MSKLC layout -- thus for our custom locale we have 0xA0000c00;  <li>The registry key with the layouts (HKLM\SYSTEM\CurrentControlSet\Control\Keyboard Layouts) is checked to see if that subkey exists; if it is not, then it is created&nbsp;and the process skips to step 5;  <li>0x00010000 is added to the KLID candidate (thus for our custom locale we will have 0xA0010c00 the first time we hit this step) and then step #3 is repeated;  <li>The following relevant&nbsp;registry values are added&nbsp;underneath the new subkey:  <ol type="a"> <li><strong>Custom Language Display&nbsp;Name</strong> - an <a href="http://msdn2.microsoft.com/library/ms538594.aspx">SHLoadIndirectString</a> style string pointing to a resource in the layout DLL that contains the name of the custom language -- for our custom locale, the resource it points to is&nbsp;<strong>Valley Girl (California);</strong>  <li><strong>Custom Language Name</strong> - A plain text version of the name of the custom language -- for our custom locale, <strong>Valley Girl (California).</strong>&nbsp;  <li><strong>Layout Display Name</strong> - an <a href="http://msdn2.microsoft.com/library/ms538594.aspx">SHLoadIndirectString</a> style string pointing to a resource in the layout DLL that contains the name of the custom keyboard layout -- for our custom keyboard, the resource it points to is <strong>Like Totally For Shure</strong>.  <li><strong>Layout Text</strong> - A plain text version of the name of the custom keyboard layout -- for our custom keyboard, <strong>Like Totally For Shure</strong>.  <li><strong>Layout Locale Name</strong> - Only present for custom languages, the name of the locale for use in name-based NLS API calls, e.g. en-US for English (United States) -- for our custom keyboard, <strong>valley-GIRL</strong>.  <li><strong>Layout Product Code</strong> - a GUID representing the ProductCode in the MSI's Property table -- for our package, <strong>{B883CD61-769F-4488-8070-FBD07C0147E7}</strong>.</li></ol></li></ol> <p>The view of the Property Table&nbsp;in the&nbsp;MSI file will look something like this (almost completely identical between all three MSI files):</p> <p><img src="http://trigeminal.fmsinc.com/images/valleygirl04.png"></p> <p>And after the install, the registry will look something like this:</p> <p><img src="http://trigeminal.fmsinc.com/images/valleygirl03.png"></p> <p>Without further adieu, the <strong>"cool for the ISV" design consequences</strong>:</p> <p>1) The <strong>Layout Product Code</strong> is identical between the i386, amd64, and ia64 versions of each package, which is a theoretical violation that may cause the likes of fellow traveler <a href="http://blogs.msdn.com/heaths/">Heath Stewart</a> to cringe but ends up being a sound decision since each of the three different packages cannot ever be run on any architecture other than the one for which it is intended.</p> <p>2) That <strong>Layout Product Code</strong> provides an excellent way for an application that installs an MSKLC-generated keyboard layout to find that specific layout, even though the KLID value may be different if other custom keyboards that use the same LANGID value are already installed.</p> <p>3) The KLID value's LOWORD provides either an excellent LANGID to use for getting locale information if it is needed OR when&nbsp;the LOWORD&nbsp;is <strong>0c00</strong> a signal to look at the <strong>Layout Locale Name</strong> registry value.</p> <p>4) The <strong>Layout Locale Name</strong> provides the name of the custom locale when one was used for the layout's creation.</p> <p>Now I will cover some other interesting and/or important design consequences in the next post in the series, but this should be plenty to get people started....</p> <p>&nbsp;</p> <p><font color="#ff0080"><em>This post brought to you by</em> <font size="6">ᕓ</font> <em>(<a href="http://www.fileformat.info/info/unicode/char/1553">U+1553</a>, a.k.a. CANADIAN SYLLABICS FE)</em></font></p>
<hr/><p><a id="4540661" href="#4540661">#</a> <strong>Ivan Petrov</strong> on 24 Aug 2007 6:06 AM:</p><div style="margin-left: 1em"><p>Hi Michael :-)</p>
<p>I've the following question:</p>
<p>How can someone USE, let's say something like the MUI technology, for the Description text when the custom Keyboard Layout is installed?</p>
<p>I mean when some user is using English User interface (MUI) to see the English Description text and if some user (on the same machine) is using a Bulgarian User interface, to see a Bulgarian Description text. All this at the Language bar and in the Text Services and Input Languages window in the Installed services under the Keyboard tree as localized node!</p>
<p>Regards,</p>
<p>Ivan.</p></div>
<p><a id="4542092" href="#4542092">#</a> <strong>Michael S. Kaplan</strong> on 24 Aug 2007 7:39 AM:</p><div style="margin-left: 1em"><P>That is one of those interesting (and dare I say it, important!) design consequences/considerations I'll be covering in the next part. :-)</P></div>
<p><a id="4542499" href="#4542499">#</a> <strong>Ivan Petrov</strong> on 24 Aug 2007 8:29 AM:</p><div style="margin-left: 1em"><p>OK Michael,</p>
<p>I'll be waiting for the next post!</p>
<p>Regards,</p>
<p>Ivan.</p></div>
<p><a id="4579559" href="#4579559">#</a> <strong>Ivan Petrov</strong> on 26 Aug 2007 5:26 PM:</p><div style="margin-left: 1em"><p>Hi</p>
<p>I've one more question here:</p>
<p>What does this &quot;A&quot; prefix mean in the Keyboard Layout Identifiers (KLID) values created by MSKLC? I'm wondering from where it came from?</p>
<p>If it was &quot;C&quot; I can say that it came from 'C'ustom - Custom created keyboard layout!?</p>
<p>But it's &quot;A&quot;? ...</p>
<p>Regards,</p>
<p>Ivan.</p></div>
<p><a id="4579843" href="#4579843">#</a> <strong>Michael S. Kaplan</strong> on 26 Aug 2007 6:00 PM:</p><div style="margin-left: 1em"><p>I actually had to choose a letter and I only had a few choices -- so I picked 'A'. :-)</p>
<p>Ok, that is not entirely true....</p>
<p>It is I suppose an easter egg of sorts, as I arbitrarily based the decision on the first names of two different women I've known -- the first being Andrea who I have talked about before, and the second a girl from Long Island that I met at a summer program in Boston many years ago. We never did keep in touch and life is such that I doubt I would ever run across her (even accidentally), but she was kind of inspiring way back when so I figured a small gesture couldn't hurt anything. </p>
<p>Well, that and wanting to keep the prefix farther away from the other prefixes that were being used.</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/05/17 <a href="http://archives.miloush.net/michkap/archive/2012/05/17/10306133.html">That 'keyboard culture list' you may have heard so much about</a></p><p>2011/11/02 <a href="http://archives.miloush.net/michkap/archive/2011/11/02/10232468.html">The evolving Story of Locale Support, part 2 (raising the roof on keyboards)</a></p><p>2008/02/25 <a href="http://archives.miloush.net/michkap/archive/2008/02/25/7893424.html">What the #$!*& is a KeyboardLayoutId, anyway?</a></p><p>2007/09/02 <a href="http://archives.miloush.net/michkap/archive/2007/09/02/4701403.html">When the NLS keyboard's notions about LCIDs aren't the same as in NLS, part #1</a></p><p>2007/08/25 <a href="http://archives.miloush.net/michkap/archive/2007/08/25/4564548.html">MSKLC keyboard layout names in your own language</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/08/24/4536979.html" title="Every character has a story #28: U+1e9e (CAPITAL SHARP S)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/08/22/4519235.html" title="İ şéè đêäđ ķéÿš">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-08">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-08-23">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/08/23/4535058.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>