<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/11/20/494829.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Private fonts: for members only</title></head><body>
<h1>Private fonts: for members only</h1>
<p><em>by Michael S. Kaplan, published on 2005/11/20 04:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/11/20/494829.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>About a month ago, I had someone ask me about the images that appeared in <A href="http://www.microsoft.com/globaldev/tools/msklc.mspx">MSKLC</A>&nbsp;for characters that had no visible representation, wondering whether they were part of a font or not. After I explained that they were, she asked me&nbsp;how this font was able to be used without it being on the machine (the font itself was not all that interesting to her, but the capability to do that with any font was).</FONT></P>
<P><FONT face=Tahoma>Then this last week,&nbsp;Rick Engle&nbsp;was asking on an internal Microsoft distribution list whether a font could&nbsp;be included as a project resource.</FONT></P>
<P><FONT face=Tahoma>So today I thought I'd take these&nbsp;two items and handle them&nbsp;both at once, since they are&nbsp;really the same item.</FONT></P>
<P><FONT face=Tahoma>The answer is that yes you can do this, and it works quite well using:</FONT></P>
<UL>
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/gdi/fontext_23zs.asp">AddFontMemResourceEx</A>/<A href="http://msdn.microsoft.com/library/en-us/gdi/fontext_8kag.asp">RemoveFontMemResourceEx</A> for GDI (unmanaged code)</FONT> 
<LI><FONT face=Tahoma>The <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemdrawingtextprivatefontcollectionclasstopic.asp">PrivateFontCollection</A> class and its <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemdrawingtextprivatefontcollectionclassaddmemoryfonttopic.asp">AddMemoryFont</A> method for GDI+ (managed code)</FONT></LI></UL>
<P><FONT face=Tahoma>The line between managed and unmanaged code can blur when you use managed code like WinForms, since some of the controls are unmanaged underneath (like the RichTextBox) and require you to use both techniques at the same time to help things work properly. There are several controls that fit into this category, so I generally find it better to be safe than sorry and just always include them both.</FONT></P>
<P><FONT face=Tahoma>And it is especially important to use both&nbsp;techniques in Whidbey (VS 2005) since GDI/Uniscribe is used in many cases rather than GDI+, as I have discussed <a href="http://archives.miloush.net/michkap/archive/2005/06/27/432986.html">previously</A>.</FONT></P><FONT face=Tahoma>
<P><FONT face=Tahoma size=4><EM>Also, be sure that you are following the licensing rules and restrictions for any font you wish to include!</EM></FONT></P>
<P>Basically, start by adding the font file to your project, right-clicking on the file in the Project Explorer, and choosing 'Embedded Resource.' The name you will load is the font file with a fully qualified name (project namespace included), e.g. <STRONG>WindowsApplication1.MyPrivateFont.ttf</STRONG>.</FONT></P>
<P><FONT face=Tahoma>Here are in namespaces we will need:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New"><STRONG>using System.Reflection;<BR>using System.Drawing;<BR>using System.Drawing.Text;<BR>using System.IO;<BR>using System.Runtime.InteropServices;</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>And here is the basic code:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><STRONG><FONT face="Courier New"><FONT color=#008000>// Adding a private font (Win2000 and later)</FONT><BR>[DllImport("gdi32.dll", ExactSpelling=true)]<BR>private&nbsp;static extern IntPtr AddFontMemResourceEx(byte[] pbFont, int cbFont, IntPtr pdv,&nbsp;out uint pcFonts);</FONT></STRONG></P>
<P><FONT face="Courier New"><STRONG><FONT color=#008000>// Cleanup of a private font (Win2000 and later)</FONT><BR>[DllImport("gdi32.dll", ExactSpelling=true)]<BR>internal static extern bool RemoveFontMemResourceEx(IntPtr fh);</STRONG></FONT></P><STRONG><FONT face="Courier New">
<P><FONT face="Courier New"><STRONG><FONT color=#008000>// Some private holders of font information we are loading</FONT><BR>static private IntPtr m_fh = IntPtr.Zero;<BR>static private PrivateFontCollection m_pfc = null;</STRONG></FONT></P>
<P><FONT color=#008000>/////////////////////////////////////<BR>//<BR>// The GetSpecialFont procedure takes a size and<BR>// create a font of that size using the hardcoded<BR>// special font name it knows about.<BR>//<BR>/////////////////////////////////////<BR></FONT>public&nbsp;Font GetSpecialFont(float size) {</FONT></STRONG></P>
<P><STRONG><FONT face="Courier New">&nbsp;&nbsp; Font fnt = null;</FONT></STRONG></P>
<P><STRONG><FONT face="Courier New">&nbsp;&nbsp; if(null == m_pfc) {</FONT></STRONG></P>
<P><FONT face="Courier New"><STRONG><FONT color=#008000>&nbsp;&nbsp; &nbsp;&nbsp; // First load the font as a memory stream</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Stream stmFont = Assembly.GetExecutingAssembly().GetManifestResourceStream(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "WindowsApplication1.MyPrivateFont.ttf");</STRONG></FONT></P>
<P><FONT face="Courier New"><STRONG>&nbsp;&nbsp; &nbsp;&nbsp; if(null != stmFont) {</STRONG></FONT></P>
<P><FONT face="Courier New" color=#008000><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // GDI+ wants a pointer to memory, GDI wants the memory.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // We will make them both happy.<BR></STRONG></FONT><STRONG><FONT face="Courier New" color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </FONT></STRONG></P>
<P><FONT face="Courier New"><STRONG><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // First read the font into&nbsp;a buffer</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte[] rgbyt = new Byte[stmFont.Length];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; stmFont.Read(rgbyt, 0, rgbyt.Length);</STRONG></FONT></P>
<P><FONT face="Courier New"><STRONG>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<STRONG><FONT face="Courier New"><FONT color=#008000>&nbsp;&nbsp; //&nbsp;Then do the unmanaged font (Windows 2000 and later)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; // The reason this works is that GDI+ will create a font object for<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // controls like the&nbsp;RichTextBox and this call will make&nbsp;sure that GDI<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; // recognizes the font name, later.</FONT><BR>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint cFonts;<BR>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddFontMemResourceEx(rgbyt, rgbyt.Length, IntPtr.Zero, ref cFonts);</FONT></STRONG></P></STRONG></FONT><FONT face="Courier New"><STRONG>
<P><FONT face="Courier New"><STRONG><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; //&nbsp;Now do the managed font</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr pbyt = Marshal.AllocCoTaskMem(rgbyt.Length);<BR></STRONG></FONT><FONT face="Courier New"><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(null != pbyt) {<BR></STRONG></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Marshal.Copy(rgbyt, 0, pbyt, rgbyt.Length);<BR></STRONG></FONT><STRONG><FONT face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; m_pfc = new PrivateFontCollection();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_pfc.AddMemoryFont(pbyt, rgbyt.Length);<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Marshal.FreeCoTaskMem(pbyt);<BR></FONT></STRONG><STRONG><FONT face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></FONT></STRONG><STRONG><FONT face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></FONT></STRONG><STRONG><FONT face="Courier New">&nbsp;&nbsp;&nbsp;</FONT></STRONG><STRONG><FONT face="Courier New">}</FONT></STRONG></P>
<P><FONT face="Courier New"><STRONG>&nbsp;&nbsp; if(m_pfc.Families.Length &gt; 0) {<BR></STRONG><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Handy how one of the&nbsp;Font constructors takes a<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // FontFamily object, huh? :-)</FONT><BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnt = new Font(m_pfc.Families[0], size);<BR><FONT face="Courier New">&nbsp;&nbsp; }</FONT></STRONG></FONT></P>
<P><STRONG><FONT face="Courier New">&nbsp;&nbsp; return fnt;<BR></FONT></STRONG><STRONG><FONT face="Courier New">}</FONT></STRONG></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Now this code is assuming you are only ever adding one font but plan to ask for different sizes of&nbsp;it; if you need to expand it to use multiple fonts then you will obviously want to take that PrivateFontCollection object&nbsp;and that IntPtr for the unmanaged font and convert them to be a collection or something to hold more than one font, perhaps using&nbsp;a Hashtable that index by the name?</FONT></P>
<P><FONT face=Tahoma>Although I was tempted to make this procedure more generic, the requirement for the font to be an embedded resource and the fact that I am technically on vacation made this seem a little less critical for a quick sample. People who are interested can obviously do what they need to here, of course!</FONT></P>
<P><FONT face=Tahoma>For cleanup, you will eventually want to dispose of your PrivateFontCollection and call RemoveFontMemResource, though for the latter the documentation claims that when the process goes away, the system will unload the fonts even if the process did not call RemoveFontMemResource (so you can base whether to call that on how clean you want your code to be!).</FONT></P>
<P><FONT face=Tahoma>Those are the basics and should be enough to get you started....</FONT></P>
<P><FONT face=Tahoma>As I think about the way that private fonts are implemented in both GDI and GDI+, a possible model for a future version of a "private CultureInfo" seems to emerge.</FONT></P>
<P><FONT face=Tahoma>It is obvious that if you are creating a CultureInfo that can be enumerated and&nbsp;used by everyone on the machine that you should have administrative permissions. But perhaps this model could be used to create a more private CultureInfo for use in a particular application. Just as with the private fonts you could not enumerate them or use them systemwide, but there already is a mechanism to get those things done. Is it something you could use in an application yourself.</FONT></P>
<P><FONT face=Tahoma>Seems like an interesting idea, right?</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6>â€°</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/2030">U+2030</A>, a.k.a. PER MILLE SIGN)<BR><FONT size=1>(A character that was quite impressed to see that I managed to add something 'international' at the end of the post!)</FONT></EM></FONT></P>
<hr/><p><a id="495177" href="#495177">#</a> <strong>Andreas Magnusson</strong> on 21 Nov 2005 3:28 AM:</p><div style="margin-left: 1em">Cool, I've been wondering if it was possible to do this or if I would have to A) force an install of my desired font or B) let the system choose a &quot;similar&quot; font... but this is great!<br></div>
<p><a id="513192" href="#513192">#</a> <strong>mg</strong> on 15 Jan 2006 11:16 PM:</p><div style="margin-left: 1em">Ohhh thanks so much. I was wrestling with PrivateFontCollection and nothing was working right or even rationally (managed directx font class).  By using AddFontMemResourceEx(), everything began to work</div>
<p><strong>RF</strong> on 13 Dec 2011 12:06 PM:</p><div style="margin-left: 1em"><p>Replace &#39;ref&#39; with &#39;out&#39; in AddFontMemResourceEx(rgbyt, rgbyt.Length, IntPtr.Zero, ref cFonts); if you have compile issues. Great article and it&#39;s good to find those that help online! </p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2015/04/23 <a href="http://archives.miloush.net/michkap/archive/2015/04/23/8770668856267196390.html">Maybe they should *write* the freaking manual!</a></p><p>2008/09/08 <a href="http://archives.miloush.net/michkap/archive/2008/09/08/8932366.html">On installing and removing fonts, Part 8: Sometimes being selfish makes you more trustworthy</a></p><p>2008/02/28 <a href="http://archives.miloush.net/michkap/archive/2008/02/28/7934894.html">Font size scaling -- GDI vs. GDI+</a></p><p>2007/06/19 <a href="http://archives.miloush.net/michkap/archive/2007/06/19/3397122.html">Why is the NULL GLYPH not the glyph representing NULL?</a></p><p>2007/05/17 <a href="http://archives.miloush.net/michkap/archive/2007/05/17/2696800.html">A private CultureAndRegionInfoBuilder does not imply a private CultureInfo</a></p><p>2007/04/14 <a href="http://archives.miloush.net/michkap/archive/2007/04/14/2134278.html">Rhymes with Amharic #3 (a.k.a. Read and write a language w/o even getting out of my [em]bed? Kewl!)</a></p><p>2007/04/14 <a href="http://archives.miloush.net/michkap/archive/2007/04/14/2128198.html">Rhymes with Amharic (a.k.a. How about a little breakfast embed, dear?)</a></p><p>2006/12/30 <a href="http://archives.miloush.net/michkap/archive/2006/12/30/1387611.html">PM agrees -- 'supporting Aero' does not mean we have to start flying (or get high by any other means)</a></p><p>2006/03/18 <a href="http://archives.miloush.net/michkap/archive/2006/03/18/554308.html">What about logical fonts?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/11/21/495070.html" title="What does &#39;accessible&#39; mean? Is U2 accessible?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/11/19/494420.html" title="Screw language; it&#39;s about the dialect, baby!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-11">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-11-20">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/11/20/494829.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>