<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/16/417711.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Font substitution and linking #2</title></head><body>
<h1>Font substitution and linking #2</h1>
<p><em>by Michael S. Kaplan, published on 2005/05/16 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/05/16/417711.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P dir=ltr style="MARGIN-RIGHT: 0px"><FONT face=Tahoma>Back in the end of March, when I posted <a href="http://archives.miloush.net/michkap/archive/2005/03/20/399322.html">Font substitution and linking #1</A>, that ordinal at the end certainly implied&nbsp;that there&nbsp;were going to be a few more posts in a series.</FONT></P>
<P><FONT face=Tahoma>Sorry it took so long to get back to the topic, I have been busy. :-)</FONT></P>
<P><FONT face=Tahoma>Now I have mentioned MLang, the MultiLanguage object used by Internet Explorer to do many different operations. From conversion to encoding detection to font linking, it does a lot of things, some of which are unavailable anywhere else in the managed or unmanaged worlds of code that runs on Microsoft platforms.</FONT></P>
<P><FONT face=Tahoma>I'll talk about some of those other "exclusive to MLang" features in the future, but this time I will be talking about <STRONG>font linking</STRONG>.</FONT></P>
<P><FONT face=Tahoma>Acording to the documentation for the <A href="http://msdn.microsoft.com/workshop/misc/mlang/reference/ifaces/imlangfontlink/imlangfontlink.asp">IMLangFontLink interface</A>:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma size=2>Font linking is a term used to describe the process of automatic font switching based on the character code values of the text stream to be rendered. For example, characters for Hebrew and Japanese are not likely included in a single font. The services provided by this interface would allow a client to switch between a Hebrew font and a Japanese font to output a string containing characters from both languages. <B>IMLangFontLink</B> does this by creating custom fonts and providing an underlying font cache in the implementation.</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Now there is no other interface that provides this support, anywhere. Even Uniscribe and GDI+ are simply consumers of font linking technology, and neither one provides the underlying mechanism to build synthetic fonts that have support for different subranges of Unicode. </FONT></P>
<P><FONT face=Tahoma>With that said, not every application needs quite an extensive of a level of support -- often the "retail" support provided by the consumers of font linking technology&nbsp;obviates the&nbsp;need for a technology that allows for the "wholesale" support of such virtual fonts. It does not stop some people from wanting that support though. And it certainly does not make people less curious about how it works!</FONT></P>
<P><FONT face=Tahoma>I'll start by pointing to a really good post that talks about using <A href="http://msdn.microsoft.com/workshop/misc/mlang/tutorials/fontlinking.asp">font linking in MLang</A>, which helps gives the actual steps you would use to implement custom font linking. It has a sample that is used to do the detection work to find out if you need to build a synethic font:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New"><FONT size=2><STRONG><FONT color=#0000ff>//</FONT><FONT color=green> IMLangFontLink* pMLangFontLink;</FONT><BR>DWORD dwFontCodePages;<BR>DWORD dwCharCodePages;<BR><BR>pMLangFontLink-&gt;GetFontCodePages(hDC, hFont, &amp;dwFontCodePages);<BR>pMLangFontLink-&gt;GetCharCodePages(ch, &amp;dwCharCodePages);<BR><BR>if(dwCharCodePages &amp; dwFontCodePages)<BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=blue>//</FONT><FONT color=green> Character ch can be output with hFont on hDC.</FONT><BR>}<BR>else<BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=blue>//</FONT><FONT color=green> Create a custom font to output the characters from</FONT><BR>&nbsp;&nbsp;&nbsp; <FONT color=blue>//</FONT><FONT color=green> dwCharCodePages.</FONT><BR>}</STRONG></FONT></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma><EM>(It might be a misnomer to call these items "code pages" since they cover things outside the range of code pages like various Uniode-only subranges. But I am not going to quibble)</EM></FONT></P>
<P><FONT face=Tahoma>I had actually started putting together a sample that showed how you would use the interface to do the actual&nbsp; font linking for that "else" case. </FONT></P>
<P><FONT face=Tahoma>But then I found that somebody else had already done it! </FONT></P>
<P><FONT face=Tahoma>So instead I will </FONT><FONT face=Tahoma>point to <a href="http://blogs.msdn.com/oldnewthing/archive/2004/07/16/185261.aspx"><STRONG>How to display a string without those ugly boxes</STRONG></A>, a post that <a href="http://blogs.msdn.com/oldnewthing/">Raymond Chen</A> did last year that gives a real world example, implementing those steps. i doubt I could have done it better, so I'll just refer to that post....</FONT></P>
<P><FONT face=Tahoma>Now one important point here that is not talked about too much in eithedr the documentation or Raymond's post is that these methods <EM>do</EM> take up resources. More than you want to tie up for any longer than you are required to.</FONT></P>
<P><FONT face=Tahoma>So, when you are completely done, the all-important <A href="http://msdn.microsoft.com/workshop/misc/mlang/reference/ifaces/imlangfontlink2/resetfontmapping.asp">IMLangFontLink2::ResetFontMapping</A>&nbsp;method is crucial -- it certainly it does more than the <A href="http://msdn.microsoft.com/workshop/misc/mlang/reference/ifaces/imlangfontlink2/releasefont.asp">IMLangFontLink2::ReleaseFont</A>&nbsp;method, which does not free up the resources associated with the synthetic font. </FONT></P>
<P><FONT face=Tahoma>I have had people ask me about it in the past, but I do not tend to think of the <A href="http://msdn.microsoft.com/workshop/misc/mlang/reference/ifaces/imlangfontlink2/releasefont.asp">IMLangFontLink2::ReleaseFont</A>&nbsp;behavior as a bug, since you may have duplicated that HFONT handle through other means outside of MLang (say in GDI). There is a strict reference counting method employed in MLang, but using that method&nbsp;to determine when to free resources could cause many application bugs. </FONT></P>
<P><FONT face=Tahoma><EM>None of which means you should ignore when the method fails -- it is a good indication that you have a "double free" bug in your code for you to look into fixing!</EM></FONT></P>
<P><FONT face=Tahoma>It does mean&nbsp;that you will definitely want to&nbsp;consider expanding Raymond's advice:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma size=2>One refinement I did not do was to avoid creating the IMlangFontLink2 pointer each time we want to draw text. In a "real program" you would probably create the multilanguage object once per drawing context (per window, perhaps) and re-use it to avoid going through the whole object creation codepath each time you want to draw a string. </FONT></P></BLOCKQUOTE>
<P>&nbsp;<FONT face=Tahoma>and applying it to the HFONT that you get back from your <A href="http://msdn.microsoft.com/workshop/misc/mlang/reference/ifaces/imlangfontlink/mapfont.asp">IMLangFontLink::MapFont</A>&nbsp;call. Otherwise, you could find yourself building up a much bigger MLang font cache than you intended....</FONT></P>
<P>Now it is not covered in too many places, but&nbsp;the advantages of <A href="http://msdn.microsoft.com/workshop/misc/mlang/reference/ifaces/imlangfontlink2/mapfont.asp">IMLangFontLink2::MapFont</A> over <?XML:NAMESPACE PREFIX = MSHelp NS = "http://msdn.microsoft.com/mshelp" /><MSHelp:link tabIndex=0 keywords="_inet_IMLangFontLink_Interface_inet_IMLangFontLink_MapFont_Method_cpp" xmlns:MSHelp="http://msdn.microsoft.com/mshelp"><U><FONT color=#0000ff>IMLangFontLink::MapFont</FONT></U></MSHelp:link> are clear for our purposes. The former supports non-Microsoft Windows codepage character font linking. To locate a font for a Unicode character not found in a codepage, just </P>
<OL>
<LI>set <EM>dwCodePages</EM> to zero and 
<LI>make sure the string passed in contains the Unicode characters you want to support</LI></OL>
<P>When you do this, all fonts on the system are then searched to locate a font which supports this character. You can obviously make this part of the process take up fewer resources by making sure the font that is the HDC you pass to <A href="http://msdn.microsoft.com/workshop/misc/mlang/reference/ifaces/imlangfontlink2/mapfont.asp">IMLangFontLink2::MapFont</A>&nbsp;is a good "first guess" as to what might be the right font. You will want to make sure to not pass a huge font like <STRONG>Arial Unicode MS</STRONG> unless you want MLang to find the glyphs there (such a font would also pass the initial test to see if font linking was even needed).</P>
<P>In future posts, I will talk more about consumers of font linking functionality, like GDI+ and Uniscribe.</P>
<P></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you by</EM> "<FONT size=3>ῴ</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/1ff4/index.htm">U+1ff4</A>, a.k.a. GREEK SMALL LETTER OMEGA WITH OXIA AND YPOGEGRAMMENI)</EM></FONT></FONT></P>
<hr/><p><a id="418122" href="#418122">#</a> <strong>Rick Cameron</strong> on 16 May 2005 4:52 PM:</p><div style="margin-left: 1em">Very timely - as it happens we're working on font linking in code that uses Uniscribe for layout. I think the approach needs to be a bit different when using Uniscribe, compared to Raymond Chen's sample working with TextOut.<br>BTW, when I say Uniscribe, I mean the low-level API (ScriptShape, ScriptPlace, etc.) not the high-level ScriptString* API.<br>My feeling is that one would do ScriptShape, then check for missing glyphs, and use MLang to help choose a substitution font, then re-run ScriptShape using the replacement font for the code points that failed the first time.<br>Any chance you could update the old Uniscribe sample from MSDN Mag (or was it MSJ at the time?) to use MLang for font linking?<br>Cheers - rick</div>
<p><a id="418151" href="#418151">#</a> <strong>Michael S. Kaplan</strong> on 16 May 2005 5:35 PM:</p><div style="margin-left: 1em">Hi Rick, LTNS!<br><br>Well, as a sample that's pretty ambitious, whether for me or for MSDN. But I may be able to see something done (here and/or elsewhere) for the various component pieces...</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/01/26 <a href="http://archives.miloush.net/michkap/archive/2012/01/26/10260726.html">If font linking doesn't fit the text to a T (or ț!), a Romanian letter may be right but not quite look it</a></p><p>2007/02/27 <a href="http://archives.miloush.net/michkap/archive/2007/02/27/1768106.html">They do it with MLang</a></p><p>2006/06/06 <a href="http://archives.miloush.net/michkap/archive/2006/06/06/618628.html">Is this the Über-font post? No, but it is the teaser for it!</a></p><p>2006/03/18 <a href="http://archives.miloush.net/michkap/archive/2006/03/18/554308.html">What about logical fonts?</a></p><p>2006/02/15 <a href="http://archives.miloush.net/michkap/archive/2006/02/15/531653.html">Mixing MLang and Uniscribe</a></p><p>2006/01/22 <a href="http://archives.miloush.net/michkap/archive/2006/01/22/515864.html">Questions about font linking, etc.</a></p><p>2006/01/06 <a href="http://archives.miloush.net/michkap/archive/2006/01/06/509772.html">When not to use MLang</a></p><p>2005/06/18 <a href="http://archives.miloush.net/michkap/archive/2005/06/18/430507.html">Font substitution and linking #3</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/05/16/418202.html" title="Making noise....">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/05/15/417663.html" title="Dry the rain">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05-16">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/16/417711.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>