<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/10/22/854820.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>It is Clear[Type] how the quality is being managed</title></head><body>
<h1>It is Clear[Type] how the quality is being managed</h1>
<p><em>by Michael S. Kaplan, published on 2006/10/22 03:02 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/10/22/854820.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<font face="Tahoma" size="3"> <p>Lots of people have pointed out both before and after I did in <a href="http://archives.miloush.net/michkap/archive/2005/04/15/408746.html"><strong>When a user sets something. please assume they meant it</strong></a> how unfortunate it is that so many different applications and processes turn on ClearType whether the user wants it on or not. </p> <p>Well, just as I previously talked about how the design of IsNLSDefinedString was actually a a bit of <a href="http://archives.miloush.net/michkap/archive/2006/05/31/612544.html"><strong>an exercise in social engineering</strong></a>, the unfortunate fact is the <a href="http://windowssdk.msdn.microsoft.com/en-us/library/ms533912(VS.80).aspx">documentation about ClearType</a> and its pointers to the <strong>fdwQuality</strong> parameter in the <a href="http://windowssdk.msdn.microsoft.com/en-us/library/ms534214(VS.80).aspx">CreateFont function</a> and the <strong>lfQuality</strong> member of the <a href="http://windowssdk.msdn.microsoft.com/en-us/library/ms533912(VS.80).aspx">LOGFONT structure</a> make it really easy to decide what you want the behavior to be: </p> <blockquote> <table width="80%" border="1"> <tbody> <tr> <td>Value</td> <td>Meaning</td></tr> <tr> <td>ANTIALIASED_QUALITY</td> <td><b>Windows NT 4.0 and later: </b>Font is antialiased, or smoothed, if the font supports it and the size of the font is not too small or too large. <br><br><b>Windows 95 with Plus!, Windows 98/Me:</b> The display must greater than 8-bit color, it must be a single plane device, it cannot be a palette display, and it cannot be in a multiple display monitor setup. In addition, you must select a TrueType font into a screen DC prior to using it in a DIBSection, otherwise antialiasing does not happen.</td></tr> <tr> <td>CLEARTYPE_QUALITY</td> <td><b>Windows XP:</b> If set, text is rendered (when possible) using ClearType antialiasing method. See Remarks for more information.</td></tr> <tr> <td>DEFAULT_QUALITY</td> <td>Appearance of the font does not matter.</td></tr> <tr> <td>DRAFT_QUALITY</td> <td>Appearance of the font is less important than when the PROOF_QUALITY value is used. For GDI raster fonts, scaling is enabled, which means that more font sizes are available, but the quality may be lower. Bold, italic, underline, and strikeout fonts are synthesized, if necessary.</td></tr> <tr> <td>NONANTIALIASED_QUALITY</td> <td><b>Windows 95 with Plus!, Windows 98/Me, Windows NT 4.0 and later: </b>Font is never antialiased, that is, font smoothing is not done.</td></tr> <tr> <td>PROOF_QUALITY</td> <td>Character quality of the font is more important than exact matching of the logical-font attributes. For GDI raster fonts, scaling is disabled and the font closest in size is chosen. Although the chosen font size may not be mapped exactly when PROOF_QUALITY is used, the quality of the font is high and there is no distortion of appearance. Bold, italic, underline, and strikeout fonts are synthesized, if necessary.</td></tr></tbody></table></blockquote> <p>Looking at wingdi.h, the values behind these constants are: </p> <blockquote><font face="Consolas,Courier New,Lucida Console,Courier"><b> <p>#define DEFAULT_QUALITY 0<br>#define DRAFT_QUALITY 1<br>#define PROOF_QUALITY 2<br>#if(WINVER &gt;= 0x0400)<br>#define NONANTIALIASED_QUALITY 3<br>#define ANTIALIASED_QUALITY 4<br>#endif /* WINVER &gt;= 0x0400 */ <br><br>#if (_WIN32_WINNT &gt;= _WIN32_WINNT_WINXP)<br>#define CLEARTYPE_QUALITY 5<br>#define CLEARTYPE_NATURAL_QUALITY 6<br>#endif</p></b></font></blockquote> <p>Yes, there is that extra CLEARTYPE_NATURAL_QUALITY constant which is defined in the header file and documented all over creation <em>except</em> on MSDN right now. Good luck trying to determine what it means. :-)</p> <p>The method that anyone who wants to ignore the user setting will use is to jut pass a different value in the fonts that are created....</p> <p>And what about managed code? </p> <p>Well,&nbsp;the truth is that GDI+ does not define any of this stuff in its font creation, as code like this shows: </p> <blockquote><font face="Consolas,Courier New,Lucida Console,Courier" size="2"><b> <p>using System;<br>using System.Drawing;<br>using System.Runtime.InteropServices; <br><br>namespace FontStuff {<br>&nbsp; class test {<br><br>&nbsp;&nbsp;&nbsp; private unsafe struct LOGFONT { <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int lfHeight; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int lfWidth; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int lfEscapement; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int lfOrientation; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int lfWeight; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte lfItalic; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte lfUnderline; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte lfStrikeOut; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte lfCharSet; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte lfOutPrecision; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte lfClipPrecision; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public QUALITY lfQuality; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte lfPitchAndFamily; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public fixed char lfFaceName[32]; <br>&nbsp;&nbsp;&nbsp; }; <br><br>&nbsp;&nbsp;&nbsp; private enum QUALITY : byte {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DEFAULT_QUALITY = 0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DRAFT_QUALITY = 1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PROOF_QUALITY = 2,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NONANTIALIASED_QUALITY = 3,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ANTIALIASED_QUALITY = 4,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CLEARTYPE_QUALITY = 5,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CLEARTYPE_NATURAL_QUALITY = 6<br>&nbsp;&nbsp;&nbsp; }<br><br></p> <p>&nbsp;&nbsp;&nbsp; [DllImport("gdi32.dll", CharSet=CharSet.Unicode, ExactSpelling=true, CallingConvention=CallingConvention.StdCall)]<br>&nbsp;&nbsp;&nbsp; private static extern int GetObjectW(IntPtr hgdiobj, int cbBuffer, out LOGFONT lpvObject);&nbsp;<br><br>&nbsp;&nbsp;&nbsp; [DllImport("gdi32.dll", CharSet=CharSet.Unicode, ExactSpelling=true, CallingConvention=CallingConvention.StdCall)]<br>&nbsp;&nbsp;&nbsp; private static extern IntPtr CreateFontIndirectW(ref LOGFONT lplf); <br><br>&nbsp;&nbsp;&nbsp; [DllImport("gdi32.dll", ExactSpelling=true, CallingConvention=CallingConvention.StdCall)]<br>&nbsp;&nbsp;&nbsp; private static extern bool DeleteObject(IntPtr hObject); <br><br>&nbsp;&nbsp;&nbsp; [STAThread]<br>&nbsp;&nbsp;&nbsp; static void Main(string[] args) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(args.Length != 1) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("You have to give a font name.");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Font fnt = new Font(args[0], 9);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr hFont = fnt.ToHfont();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LOGFONT lf = new LOGFONT();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(GetObjectW(hFont, Marshal.SizeOf(lf), out lf) != 0) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("The GDI+ lfQuality of '{0}' is {1}.", args[0], lf.lfQuality); <br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lf.lfQuality = QUALITY.CLEARTYPE_QUALITY;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr hFont2 = CreateFontIndirectW(ref lf);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(hFont2 != IntPtr.Zero) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Font fnt2 = Font.FromHfont(hFont2);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr hFont3 = fnt.ToHfont();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LOGFONT lf2 = new LOGFONT();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(GetObjectW(hFont3, Marshal.SizeOf(lf2), out lf2) != 0) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("The modified GDI+ lfQuality of '{0}' is {1}.", args[0], lf2.lfQuality);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DeleteObject(hFont2);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp; }<br>} <p></p></b></font></blockquote> <p>It will pretty much always return DEFAULT_QUALITY for any font created from GDI+ even if it is created with a ClearType-enabled font on the Win32 side. And the same thing will happen with any font that heads through GDI+. This makes it much harder to actually translate ClearType usage across the managed/unmanaged boundary of GDI/GDI+.</p> <p>To get ClearType support within GDI+, as the MSDN help topic <a href="http://msdn.microsoft.com/library/en-us/cpguide/html/_gdiplus_antialiasing_with_text_usecsharp.asp">Antialiasing with Text</a> indicates, you have to&nbsp;set the <a href="http://msdn2.microsoft.com/en-us/library/system.drawing.graphics.textrenderinghint.aspx">Graphics.TextRenderingHint</a> property to one of the members of the <a href="http://msdn2.microsoft.com/en-us/library/system.drawing.text.textrenderinghint.aspx">TextRenderingHint enumeration</a>. </p> <p>The docs are not entirely clear on the point though,&nbsp;because even though they say things like</p> <blockquote> <p><font size="1">The quality ranges from text (fastest performance, but lowest quality) to antialiased text (better quality, but slower performance) to ClearType text (best quality on an LCD display).</font></p></blockquote> <p>the actual values behind the enumeration are not given, and the members are listed alphabetically rather than by any kind of range order. The actual ordered list, values 0 to 5, would be:</p> <ul> <li>SystemDefault  <li>SingleBitPerPixelGridFit  <li>SingleBitPerPixel  <li>AntiAliasGridFit  <li>AntiAlias  <li>ClearTypeGridFit</li></ul> <p>Now this list does not seem to be in any kind of range order either, for what its worth. :-)</p> <p>Though by making it a setting to make for each Graphics object rather than each font, it is perhaps a bit less common to actually change the value from what the system wants. It is a subtle difference, but in the end you are hopefully much more likely to see (for example) WinForms&nbsp;applications follow the system settings. Thank goodness for small favors.</p> <p>Now&nbsp;Avalon (WPF) does this an entirely different way, and I will have to talk about that another day....</p> <p>&nbsp;</p> <p><font color="#ff0080"><em>This post brought to you by</em> <strong><font face="Code2000" size="6">âŽš</font></strong> <em>(<a href="http://www.fileformat.info/info/unicode/char/239a">U+239a</a>, a.k.a. CLEAR SCREEN SYMBOL)</em></font></p></font>
<hr/><p><a id="859904" href="#859904">#</a> <strong>Robert</strong> on 23 Oct 2006 2:05 AM:</p><div style="margin-left: 1em"><p>CLEARTYPE_NATURAL_QUALITY: My guess was that text output functions would use native ClearType metrics rather than adjust glyphs to fit the metrics of ANTIALIASED_QUALITY/NONANTIALIASED_QUALITY. For example, 8pt Tahoma 's' on 96dpi is one pixel wider with CLEARTYPE_NATURAL_QUALITY enabled. But I may be entirely wrong...</p></div>
<p><a id="860865" href="#860865">#</a> <strong>Mike Dimmick</strong> on 23 Oct 2006 5:37 AM:</p><div style="margin-left: 1em"><p>I had an experience with Vista's scaling options on my new laptop over the weekend. The laptop has a 15.4&quot; panel in 16:10 at 1680x1050 pixels, which makes it about 13.06&quot; across and therefore about 128ppi. So I used the DPI control panel to set 120dpi - and received the same nasty font shapes and bad scaling that happened in Windows XP.</p>
<p>I thought Vista was supposed to fix this? I went back into the DPI Settings dialog and tried custom settings, and spotted the 'Use Windows XP Scaling' checkbox, which was checked. I unchecked it.</p>
<p>I can see why it was checked by default. With this checkbox checked, Vista applies ClearType _before_ passing the texture to the video card to be scaled. Result, really, really blurry text. Horrible.</p>
<p>I went back to 96 dpi. It might be that I'm more familiar with those character shapes, but it looks a lot better.</p>
<p>Then I wiped Vista (build 5744) off, because I'm not going to upgrade. I really just wanted to see how well the new computer performed compared to the old one (very well, although I had to run the experience score calculator a second time because I didn't believe the desktop graphics score of 2.2 - this went up to 3.1 the second time round).</p>
<p>With Vista it's very much, &quot;you had me and you lost me.&quot; Through the betas I had problems with eVC 3.0 and 4.0 (still essential for my work) but hoped that these would get a compatibility shim. The announcement that VS2003 and SQL Server 2000 would not be supported was a blow, and you probably lost me at that point, but the licensing announcements have switched me to advising friends not to bother. I'm really sorry for you guys with the hard work that you've put in, because your management and marketing seems to have blown it at the last minute.</p>
</div>
<p><a id="862930" href="#862930">#</a> <strong>Michael S. Kaplan</strong> on 23 Oct 2006 10:20 AM:</p><div style="margin-left: 1em"><p>Hi Mike, </p>
<p>Peter Constable has gotten me interested in the whole &quot;Natural DPI&quot; thing -- where you use a custom setting and get the ruler to make the inch look exactly like an inch. It made everything look pretty good (XP scaling off, of course!).... </p>
<p>It's too bad you didn't leave it installed just a little bit longer, in my opinion. You know, at least long enough to be able to look at some of the cool international features? :-)</p>
<p>But I understand what you are saying, and I hope you end up with an opportunity to reconsider at some point, because there are some really cool things there....</p>
</div>
<p><a id="866024" href="#866024">#</a> <strong>Mike Dimmick</strong> on 23 Oct 2006 6:59 PM:</p><div style="margin-left: 1em"><p>I'm just trying custom scaling on XP and IE7 is a little broken! You may not be aware that they're turning off ClearType (even if ClearType is ON in the Desktop control panel, grrr) anywhere that one of the DirectX Transforms is enabled, which gives you poor aliased type in the left-hand pane and bottom bar on the microsoft.com homepage, and numerous places on msdn.microsoft.com due to the use of gradient fills. Anyway, on turning on 144dpi (150%), the formerly aliased text seems to be rendered at 96dpi then scaled up using some filtering technique, because it's extremely blurry. It's the same at 120dpi, actually!</p>
<p>The fact that this was not spotted in beta suggests that I'm not the only one who sticks with 96dpi regardless of the monitor's actual ppi.</p>
<p>The icons on the buttons in the Favorites Center are also way too small. I'm not sure if that's better or worse than being hideously scaled like the icons in the shutdown dialog.</p>
<p>I'd post this on Connect, but the IE7 team have just shut down their feedback site for the time being. Presumably this is to review all the bugs and suggestions that weren't implemented in IE7 final.</p>
<p>Another problem I have is that I'd like to be able to use my old monitor - 19&quot; LCD at 1280x1024, approx 86ppi - as a second monitor, but I can only select one global DPI value. Whichever DPI setting I choose will be a compromise.</p>
</div>
<p><a id="871199" href="#871199">#</a> <strong>Dean Harding</strong> on 25 Oct 2006 1:58 AM:</p><div style="margin-left: 1em"><p>Mike: I'm not sure what you mean by the text scaling issues. If you have that &quot;Use XP-style scaling&quot; UN-checked, then things certainly look pretty horrible most of the time (unless you manually go in to each application an uncheck the &quot;apply scaling&quot; in it's compatibly dialog). But if you check the XP-style scaling, then things look pretty good, in my opinion.</p>
<p>Well, mostly. Bitmaps don't scale very well, unfortunately. But I would definitely agree that most Microsofties probably don't run at anything other than the default 96DPI, because there are some pretty brain dead bugs in a few Microsoft apps (and of course, Win Forms has pretty atrocious support for non-96DPI display built right in, but at least that's fixed for WPF). At list Microsoft apps are better than most other software out there, though!</p>
<p>Non-96DPI support is something that's pretty near-and-dear to my heart, having run my laptop at a higher DPI for a couple of years now. MOST things are getting better, but you do sometimes run into a backwards step (like when upgrading from MSN messenger, which did high DPI nicely, to Windows Live Messenger, which does not).</p>
<p>I also agree that not being able to set DPI separately for each screen is a bit annoying (like not being able to set ClearType separately for each display, but lets not go there :).</p>
</div>
<p><a id="871217" href="#871217">#</a> <strong>Michael S. Kaplan</strong> on 25 Oct 2006 2:14 AM:</p><div style="margin-left: 1em"><P>On my Latitude D820:</P>
<UL>
<LI>130 DPI (one inch == 1 inch in the dialog)</LI>
<LI>resolution 1680 x 1050</LI>
<LI>XP scaling off</LI>
<LI>font sizes in Shell reduced to 7pt</LI>
<LI>other shell desktop settings reduced to match</LI></UL>
<P>Everything looks about the same size on the screen as it did at 96 DPI but everything looks sharper and crisper....</P></div>
<p><a id="871259" href="#871259">#</a> <strong>Dean Harding</strong> on 25 Oct 2006 2:57 AM:</p><div style="margin-left: 1em"><p>I'm about the same, except I turn XP scaling ON. The problem with having it off is that most apps are scaled by simply scaling their bitmap which makes everything blurry. The other problem I had with it was that some dialogs which tried to pop up in the centre of the screen ended up being moved down and to the right... (plus a couple of other &quot;minor&quot; bugs)</p>
<p>Though, to be honest, I only tried it in Vista beta 2, never in any of the RC versions, so maybe it improved?</p>
</div>
<p><a id="890020" href="#890020">#</a> <strong>Yuhong Bao</strong> on 28 Oct 2006 2:40 PM:</p><div style="margin-left: 1em"><p>&quot;The announcement that VS2003 and SQL Server 2000 would not be supported was a blow, and you probably lost me at that point, but the licensing announcements have switched me to advising friends not to bother. I'm really sorry for you guys with the hard work that you've put in, because your management and marketing seems to have blown it at the last minute.&quot;</p>
<p>Maybe, but if I were forced to choose between supporting VB 6 and VS 2003 when VS 2005 is supported, I would choose VB 6. Because it is MUCH easier to upgrade from VB .NET 2003 to VB 2005 than upgrading from VB 6 to VB 2005.</p></div>
<p><a id="6091792" href="#6091792">#</a> <strong>shyam</strong> on 11 Nov 2007 2:48 AM:</p><div style="margin-left: 1em"><P>i want to create a keyboard usercontrol in vb 6 what can i do</P></div>
<p><a id="6098460" href="#6098460">#</a> <strong>Michael S. Kaplan</strong> on 11 Nov 2007 7:16 AM:</p><div style="margin-left: 1em"><p>Maybe ask over in the Suggestion Box, for starters? The question has nothing to do with this post whatsoever....</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2006/10/25 <a href="http://archives.miloush.net/michkap/archive/2006/10/25/871264.html">It is a challenge to make ClearType irrelevant</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/10/22/858258.html" title="Making your own LIP?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/10/21/854225.html" title="Will your laptop battery explode? Check the number and maybe you&#39;ll recall....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-10-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/10/22/854820.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>